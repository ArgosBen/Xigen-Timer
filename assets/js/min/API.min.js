"object"!=typeof XIGENTIMER&&(XIGENTIMER={}),function(t){"use strict";var e,n,i=require("node-rest-client").Client,o=new i;t.API={base:function(t,i,a,r){var c,s,u,f,l,g,I,h={};console.log(t,i,a),c=function(){localforage.getItem("user",function(t){g=t.UserID,n=t.Name,h.headers={Authorization:s,"Content-Type":"application/json"},a&&(h.data="object"==typeof a?JSON.stringify(a):a)}).then(u)},u=function(){o[t.toLowerCase()](e+i,h,function(t,e){t&&("object"!=typeof t&&(f=JSON.parse(t)),"object"!=typeof t&&(t=JSON.parse(t)),t.length||(t=[t]),I=t[0].UserID?t.filter(function(t){return t.UserID===g}):t[0].Members?t.filter(function(t){return t.Members.split("\n").indexOf(n)>-1}):t.filter(function(t){return t.CanCreateTimeEntries})),"function"==typeof r&&(200===e.statusCode||201===e.statusCode?r(!0,I,f):r(!1))})},l=function(){localforage.getItem("userToken",function(t){s=t}).then(c)},e?l():localforage.getItem("baseURL",function(t){e=t.indexOf("/rest/v1/")>-1?t:t+"/rest/v1/"}).then(l)},authoriseAPI:function(t,n){var i,a,r;r=function(){o.get(e+"users",{headers:{Authorization:i,"Content-Type":"application/json"}},function(e,i){return e?(e=JSON.parse(e),e=e.filter(function(e){return e.Login===t})[0],n(200===i.statusCode,e),void 0):(n(!1),!1)})},a=function(){i?localforage.getItem("baseURL",function(t){e=t.indexOf("/rest/v1/")>-1?t:t+"/rest/v1/"}).then(r):n(!1)},localforage.getItem("userToken",function(t){i=t}).then(a)},getHierachy:function(e){var n,i=[],o=[],a={},r=0;n=function(t){var e,n=[],i=[];return t=t.filter(function(t){return 1===t.TaskStatusID||18===t.TaskStatusID||4===t.TaskStatusID}),n=t.filter(function(t){return t.HasChild>0}),i=t.filter(function(t){return t.ParentID}),n.length>0?($.each(n,function(t,o){e=o.EntityBaseID,n[t].Activities||(n[t].Activities=[]),n[t].Activities=i.filter(function(t){return t.ParentID===e})}),n.filter(function(t){return!t.ParentID})):t},t.API.base("GET","projects",{},function(c,s){i=s,localforage.setItem("projectCache",s),$.each(s,function(c,s){s.Activities=[],a[s.EntityBaseID]=this,t.API.base("GET","projects/"+s.EntityBaseID+"/activities",{},function(t,c){r+=1,o=o.concat(c),localforage.setItem("activityCache",o),a[s.EntityBaseID].Activities=n(c),r===i.length&&"function"==typeof e&&e(a)})})})},getTimelogs:function(e){t.API.base("GET","timelogs",{},function(t,n,i){localforage.setItem("timelogCache",i),e(n)})},getTimeForTask:function(t,e){var n;localforage.getItem("timelogCache",function(i){n=i.filter(function(e){return e.TaskID===t}).map(function(t){return t.Duration}),console.log(n),n=n.length?n.reduce(function(t,e){return t+e}):0,e(n)})},logTime:function(e,n,i,o,a,r){var c,s=new Date;c=[s.getFullYear(),"-",1===s.getMonth().toString().length?"0"+(s.getMonth()+1):s.getMonth()+1,"-",1===s.getDate().toString().length?"0"+s.getDate():s.getDate(),"T",s.getHours(),":",1===s.getMinutes().toString().length?"0"+s.getMinutes():s.getMinutes(),":",1===s.getSeconds().toString().length?"0"+s.getSeconds():s.getSeconds()].join(""),t.API.base("POST","timelogs",{UserID:e,Duration:i,TaskID:n,Description:a,Billable:o,EntryDate:c},function(t,e){r(e)})},markForReview:function(e,n){var i,o,a;localforage.getItem("activityCache",function(t){a=t.filter(function(t){return t.TaskID===e})[0],o=a.TaskTypeID}).then(i),i=function(){t.API.base("PUT","activities/"+e,{EntityBaseID:e,TaskStatusID:1===o?18:8},function(t){n(t)})}},updateTimeLog:function(t,n,i,a){var r,c,s,u,f=!1;s=function(){o.get(e+"timelogs/"+t,{headers:{Authorization:r,"Content-Type":"application/json"}},function(t){u=JSON.parse(t),u.Duration!==n&&(f=!0,u.Duration=parseFloat(n)),u.Description!==i&&(f=!0,u.Description=i),delete u.LastModificationDate,f?c():a(!0)})},c=function(){o.put(e+"timelogs/"+t,{headers:{Authorization:r,"Content-Type":"application/json"},data:JSON.stringify(u)},function(t,e){"function"==typeof a&&a(200===e.statusCode)})},localforage.getItem("userToken",function(t){r=t}).then(s)}}}(XIGENTIMER);