"object"!=typeof XIGENTIMER&&(XIGENTIMER={}),function(t){"use strict";var e,n,i=require("node-rest-client").Client,o=new i;t.API={base:function(t,i,r,a){var c,s,u,f,g,l,I,h={};c=function(){localforage.getItem("user",function(t){l=t.UserID,n=t.Name,h.headers={Authorization:s,"Content-Type":"application/json"},r&&(h.data="object"==typeof r?JSON.stringify(r):r)}).then(u)},u=function(){o[t.toLowerCase()](e+i,h,function(t,e){t&&("object"!=typeof t&&(f=JSON.parse(t)),"object"!=typeof t&&(t=JSON.parse(t)),t.length||(t=[t]),I=t[0].UserID?t.filter(function(t){return t.UserID===l}):t[0].Members?t.filter(function(t){return t.Members.split("\n").indexOf(n)>-1}):t.filter(function(t){return t.CanCreateTimeEntries})),"function"==typeof a&&(200===e.statusCode||201===e.statusCode?a(!0,I,f):a(!1))})},g=function(){localforage.getItem("userToken",function(t){s=t}).then(c)},e?g():localforage.getItem("baseURL",function(t){e=t.indexOf("/rest/v1/")>-1?t:t+"/rest/v1/"}).then(g)},authoriseAPI:function(t,n){var i,r,a;a=function(){o.get(e+"users",{headers:{Authorization:i,"Content-Type":"application/json"}},function(e,i){return e?(e=JSON.parse(e),e=e.filter(function(e){return e.Login===t})[0],n(200===i.statusCode,e),void 0):(n(!1),!1)})},r=function(){i?localforage.getItem("baseURL",function(t){e=t.indexOf("/rest/v1/")>-1?t:t+"/rest/v1/"}).then(a):n(!1)},localforage.getItem("userToken",function(t){i=t}).then(r)},getHierachy:function(e,n){var i,o=[],r=[],a={},c=0;n||(n=e,e=!1),i=function(t,e){var n,i=[],o=[],r=[];return t=e?t.filter(e):t.filter(function(t){return t.EndDate&&(1===t.TaskStatusID||4===t.TaskStatusID)}),t=t.filter(function(t){return t.CanCreateTimeEntries===!0}),i=t.filter(function(t){return t.HasChild>0}),o=t.filter(function(t){return t.ParentID}),r=t.filter(function(t){return!t.ParentID&&!t.HasChild}),i.length>0?($.each(i,function(t,e){n=e.EntityBaseID,i[t].Activities||(i[t].Activities=[]),i[t].Activities=o.filter(function(t){return t.ParentID===n})}),r.length>0&&(i=i.concat(r)),i.filter(function(t){return t.Activities?!t.ParentID&&t.Activities.length>0:!t.ParentID})):t},t.API.base("GET","projects",{},function(s,u){o=u,localforage.setItem("projectCache",u),$.each(u,function(s,u){u.Activities=[],a[u.EntityBaseID]=this,t.API.base("GET","projects/"+u.EntityBaseID+"/activities",{},function(t,s){c+=1,r=r.concat(s),localforage.setItem("activityCache",r),a[u.EntityBaseID].Activities=i(s,e),c===o.length&&"function"==typeof n&&n(a)})})})},getTimelogs:function(e){t.API.base("GET","timelogs",{},function(t,n,i){localforage.setItem("timelogCache",i),e(n)})},getTimeForTask:function(t,e){var n;localforage.getItem("timelogCache",function(i){n=i.filter(function(e){return e.TaskID===t}).map(function(t){return t.Duration}),n=n.length?n.reduce(function(t,e){return t+e}):0,e(n)})},logTime:function(e,n,i,o,r,a){var c,s=new Date;c=[s.getFullYear(),"-",1===s.getMonth().toString().length?"0"+(s.getMonth()+1):s.getMonth()+1,"-",1===s.getDate().toString().length?"0"+s.getDate():s.getDate(),"T",1===s.getHours().toString().length?"0"+s.getHours():s.getHours(),":",1===s.getMinutes().toString().length?"0"+s.getMinutes():s.getMinutes(),":",1===s.getSeconds().toString().length?"0"+s.getSeconds():s.getSeconds()].join(""),t.API.base("POST","timelogs",{UserID:e,Duration:i,TaskID:n,Description:r,Billable:o,EntryDate:c},function(t){a(t)})},markForReview:function(e,n){var i,o,r;localforage.getItem("activityCache",function(t){r=t.filter(function(t){return t.TaskID===e})[0],o=r.TaskTypeID}).then(i),i=function(){t.API.base("PUT","activities/"+e,{EntityBaseID:e,TaskStatusID:1===o?18:8},function(t){n(t)})}},updateTimeLog:function(t,n,i,r){var a,c,s,u,f=!1;s=function(){o.get(e+"timelogs/"+t,{headers:{Authorization:a,"Content-Type":"application/json"}},function(t){u=JSON.parse(t),u.Duration!==n&&(f=!0,u.Duration=parseFloat(n)),u.Description!==i&&(f=!0,u.Description=i),delete u.LastModificationDate,f?c():r(!0)})},c=function(){o.put(e+"timelogs/"+t,{headers:{Authorization:a,"Content-Type":"application/json"},data:JSON.stringify(u)},function(t,e){"function"==typeof r&&r(200===e.statusCode)})},localforage.getItem("userToken",function(t){a=t}).then(s)},pulse:function(){var t;XIGENTIMER.VIEWMODEL.isChecking(!0),localforage.getItem("baseURL",function(e){t(e)}),t=function(t){o.get(t,function(t,e){e.statusCode&&(XIGENTIMER.VIEWMODEL.isConnected(!0),XIGENTIMER.VIEWMODEL.isChecking(!1))}).on("error",function(){XIGENTIMER.VIEWMODEL.isConnected(!1),XIGENTIMER.VIEWMODEL.isChecking(!1)})}}}}(XIGENTIMER);