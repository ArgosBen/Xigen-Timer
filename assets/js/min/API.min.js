"object"!=typeof XIGENTIMER&&(XIGENTIMER={}),function(t){"use strict";var e,n,o=require("restler");t.API={base:function(t,i,r,a){var c,u,s,f,l,g,I,E={};c=function(){localforage.getItem("user",function(t){g=t.UserID,n=t.Name,E.headers={Authorization:u,"Content-Type":"application/json"},0!==Object.keys(r).length&&(E.data="object"==typeof r?JSON.stringify(r):r)}).then(s)},s=function(){o[t.toLowerCase()](e+i,E).on("complete",function(t,e){t&&(f="object"!=typeof t?JSON.parse(t):t,"object"!=typeof t&&(t=JSON.parse(t)),t.length||(t=[t]),I=t[0].UserID?t.filter(function(t){return t.UserID===g}):t[0].Members?t.filter(function(t){return t.Members.split("\n").indexOf(n)>-1}):t.filter(function(t){return t.CanCreateTimeEntries})),"function"==typeof a&&(200===e.statusCode||201===e.statusCode?a(!0,I,f):a(!1))}).on("error",function(t){alert("Network Error: "+JSON.stringify(t.request.options))})},l=function(){localforage.getItem("userToken",function(t){u=t}).then(c)},e?l():localforage.getItem("baseURL",function(t){e=t.indexOf("/rest/v1/")>-1?t:t+"/rest/v1/"}).then(l)},authoriseAPI:function(t,n){var i,r,a;a=function(){o.get(e+"users",{headers:{Authorization:i,"Content-Type":"application/json","Content-Length":2}}).on("complete",function(e){return e?(e=e.filter(function(e){return e.Login===t})[0],n(!0,e),void 0):(n(!1),!1)})},r=function(){i?localforage.getItem("baseURL",function(t){e=t.indexOf("/rest/v1/")>-1?t:t+"/rest/v1/"}).then(a):n(!1)},localforage.getItem("userToken",function(t){i=t}).then(r)},getHierachy:function(e,n){var o,i=[],r=[],a={},c=0;n||(n=e,e=!1),o=function(t,e){var n,o=[],i=[],r=[];return t=e?t.filter(e):t.filter(function(t){return t.EndDate&&(1===t.TaskStatusID||4===t.TaskStatusID)}),t=t.filter(function(t){return t.CanCreateTimeEntries===!0}),o=t.filter(function(t){return t.HasChild>0}),i=t.filter(function(t){return t.ParentID}),r=t.filter(function(t){return!t.ParentID&&!t.HasChild}),o.length>0?($.each(o,function(t,e){n=e.EntityBaseID,o[t].Activities||(o[t].Activities=[]),o[t].Activities=i.filter(function(t){return t.ParentID===n})}),r.length>0&&(o=o.concat(r)),o.filter(function(t){return t.Activities?!t.ParentID&&t.Activities.length>0:!t.ParentID})):t},t.API.base("GET","projects",{},function(u,s){i=s,localforage.setItem("projectCache",s),$.each(s,function(u,s){s.Activities=[],a[s.EntityBaseID]=this,t.API.base("GET","projects/"+s.EntityBaseID+"/activities",{},function(t,u){c+=1,r=r.concat(u),localforage.setItem("activityCache",r),a[s.EntityBaseID].Activities=o(u,e),c===i.length&&"function"==typeof n&&n(a)})})})},getTimelogs:function(e){t.API.base("GET","timelogs",{},function(t,n,o){localforage.setItem("timelogCache",o),"function"==typeof e&&e(n)})},getTimeForTask:function(t,e){var n;localforage.getItem("timelogCache",function(o){n=o.filter(function(e){return e.TaskID===t}).map(function(t){return t.Duration}),n=n.length?n.reduce(function(t,e){return t+e}):0,e(n)})},getProjectName:function(t,e){var n;localforage.getItem("projectCache",function(o){n=o.filter(function(e){return e.ProjectID===t})[0].Name,"function"==typeof e&&e(n)})},logTime:function(e,n,o,i,r,a){var c,u=new Date;c=[u.getFullYear(),"-",1===u.getMonth().toString().length?"0"+(u.getMonth()+1):u.getMonth()+1,"-",1===u.getDate().toString().length?"0"+u.getDate():u.getDate(),"T",1===u.getHours().toString().length?"0"+u.getHours():u.getHours(),":",1===u.getMinutes().toString().length?"0"+u.getMinutes():u.getMinutes(),":",1===u.getSeconds().toString().length?"0"+u.getSeconds():u.getSeconds()].join(""),t.API.base("POST","timelogs",{UserID:e,Duration:o,TaskID:n,Description:r,Billable:i,EntryDate:c},function(t){a(t)})},markForReview:function(e,n){var o=XIGENTIMER.VIEWMODEL.taskTypeID();t.API.base("PUT","activities/"+e,{EntityBaseID:e,TaskStatusID:1===o?18:8},function(t){n(t)})},updateTimeLog:function(t,n,i,r){var a,c,u,s,f=!1;u=function(){o.get(e+"timelogs/"+t,{headers:{Authorization:a,"Content-Type":"application/json"}}).on("complete",function(t){s=t,s.Duration!==n&&(f=!0,s.Duration=parseFloat(n)),s.Description!==i&&(f=!0,s.Description=i),delete s.LastModificationDate,f?c():r(!0)})},c=function(){o.put(e+"timelogs/"+t,{headers:{Authorization:a,"Content-Type":"application/json"},data:JSON.stringify(s)}).on("complete",function(t,e){"function"==typeof r&&r(200===e.statusCode)})},localforage.getItem("userToken",function(t){a=t}).then(u)},pulse:function(t){var e;XIGENTIMER.VIEWMODEL.isChecking(!0),localforage.getItem("baseURL",function(t){t?e(t):(XIGENTIMER.VIEWMODEL.isConnected(!1),XIGENTIMER.VIEWMODEL.isChecking(!1))}),e=function(e){o.get(e).on("complete",function(e,n){n.statusCode&&(XIGENTIMER.VIEWMODEL.isConnected(!0),XIGENTIMER.VIEWMODEL.isChecking(!1),"function"==typeof t&&t(!0))}).on("error",function(){XIGENTIMER.VIEWMODEL.isConnected(!1),XIGENTIMER.VIEWMODEL.isChecking(!1),"function"==typeof t&&t(!1)})}}}}(XIGENTIMER);