"object"!=typeof XIGENTIMER&&(XIGENTIMER={}),function(t){"use strict";var e,n,i=require("node-rest-client").Client,o=new i;t.API={base:function(t,i,a,r){var s,c,u,f,l,g,I={};s=function(){localforage.getItem("user",function(t){l=t.UserID,n=t.Name,I.headers={Authorization:c,"Content-Type":"application/json"},a&&(I.data="object"==typeof a?JSON.stringify(a):a)}).then(u)},u=function(){o[t.toLowerCase()](e+i,I,function(t,e){t&&("object"!=typeof t&&(t=JSON.parse(t)),t.length||(t=[t]),g=t[0].UserID?t.filter(function(t){return t.UserID===l}):t[0].Members?t.filter(function(t){return t.Members.split("\n").indexOf(n)>-1}):t.filter(function(t){return t.CanCreateTimeEntries})),"function"==typeof r&&(200===e.statusCode||201===e.statusCode?r(!0,g):r(!1))})},f=function(){localforage.getItem("userToken",function(t){c=t}).then(s)},e?f():localforage.getItem("baseURL",function(t){e=t.indexOf("/rest/v1/")>-1?t:t+"/rest/v1/"}).then(f)},authoriseAPI:function(e){t.API.base("GET","users",{},function(t,n){e(n)})},getHierachy:function(e){var n,i=[],o=[],a={},r=0;n=function(t){var e,n=[],i=[];return t=t.filter(function(t){return 1===t.TaskStatusID||18===t.TaskStatusID||4===t.TaskStatusID}),n=t.filter(function(t){return t.HasChild>0}),i=t.filter(function(t){return t.ParentID}),n.length>0?($.each(n,function(t,o){e=o.EntityBaseID,n[t].Activities||(n[t].Activities=[]),n[t].Activities=i.filter(function(t){return t.ParentID===e})}),n.filter(function(t){return!t.ParentID})):t},t.API.base("GET","projects",{},function(s,c){i=c,localforage.setItem("projectCache",c),$.each(c,function(s,c){c.Activities=[],a[c.EntityBaseID]=this,t.API.base("GET","projects/"+c.EntityBaseID+"/activities",{},function(t,s){r+=1,o=o.concat(s),localforage.setItem("activityCache",o),a[c.EntityBaseID].Activities=n(s),r===i.length&&"function"==typeof e&&e(a)})})})},getTimelogs:function(e){t.API.base("GET","timelogs",{},function(t,n){e(n)})},getTimeForTask:function(e,n){var i,o;t.API.base("GET","timelogs",{},function(t,a){i=a.filter(function(t){return t.TaskID===e}),i.length||(i=[i]),window.logs=i,o=i.map(function(t){return t.Duration}).reduce(function(t,e){return t+e}),n(o||0)})},logTime:function(e,n,i,o,a,r){var s,c=new Date;s=[c.getFullYear(),"-",1===c.getMonth().toString().length?"0"+(c.getMonth()+1):c.getMonth()+1,"-",1===c.getDate().toString().length?"0"+c.getDate():c.getDate(),"T",c.getHours(),":",1===c.getMinutes().toString().length?"0"+c.getMinutes():c.getMinutes(),":",1===c.getSeconds().toString().length?"0"+c.getSeconds():c.getSeconds()].join(""),t.API.base("POST","timelogs",{UserID:e,Duration:i,TaskID:n,Description:a,Billable:o,EntryDate:s},function(t,e){r(e)})},markForReview:function(e,n){var i,o,a;localforage.getItem("activityCache",function(t){a=t.filter(function(t){return t.TaskID===e})[0],o=a.TaskTypeID}).then(i),i=function(){t.API.base("PUT","activities/"+e,{EntityBaseID:e,TaskStatusID:1===o?18:8},function(t){n(t)})}},updateTimeLog:function(t,n,i,a){var r,s,c,u,f=!1;c=function(){o.get(e+"timelogs/"+t,{headers:{Authorization:r,"Content-Type":"application/json"}},function(t){u=JSON.parse(t),u.Duration!==n&&(f=!0,u.Duration=parseFloat(n)),u.Description!==i&&(f=!0,u.Description=i),delete u.LastModificationDate,f?s():a(!0)})},s=function(){o.put(e+"timelogs/"+t,{headers:{Authorization:r,"Content-Type":"application/json"},data:JSON.stringify(u)},function(t,e){"function"==typeof a&&a(200===e.statusCode)})},localforage.getItem("authToken",function(t){r=t}).then(c)}}}(XIGENTIMER);