$(function(){"use strict";var e,t,i,o=require("nw.gui"),n=$(".login [type=submit]"),a=[];$(document).foundation(),$(".login").hide(),$(".datepicker").each(function(){t=new Pikaday({field:this,firstDay:1,defaultDate:new Date,setDefaultDate:!0,maxDate:new Date,format:"D MMM YYYY",onSelect:function(){XIGENTIMER.updateDatePickers()}}),$(this).data("picker",t),a.push(t)}),$("[data-logout]").on("click",function(e){e.preventDefault(),localforage.setItem("userToken",null),localforage.setItem("userName",null),localforage.setItem("baseURL",null),localforage.setItem("user",null),localforage.setItem("savedStates",null),XIGENTIMER.reset(),XIGENTIMER.VIEWMODEL.reset(!0),$(".login").fadeIn(200)}),i=function(){n.text("Incorrect login, try again :)"),n.addClass("alert"),setTimeout(function(){n.text(e).removeClass("alert")},1500)},$("[data-login]").on("submit",function(t){t.preventDefault();var o=$("[name=password]",this).val(),a=$("[name=user]",this).val(),s=$("[name=baseURL]",this).val();e=n.text(),n.text("Logging in..."),a&&o&&s?localforage.setItem("baseURL",s).then(XIGENTIMER.authoriseUser(a,o,function(t,o){t?(n.text(e),localforage.setItem("user",t),localforage.setItem("userToken",o),localforage.setItem("userName",t.Login),localforage.setItem("baseURL",s),XIGENTIMER.VIEWMODEL.isLoggedIn(!0),XIGENTIMER.VIEWMODEL.updateFromFilters(function(){XIGENTIMER.updateDatePickers()}),XIGENTIMER.API.pulse(),XIGENTIMER.drawTaskList(),setTimeout(function(){XIGENTIMER.API.pulse()},3e4)):i()})):i()}),localforage.getItem("userToken",function(e){localforage.getItem("baseURL",function(t){e&&t?XIGENTIMER.authoriseUser(function(){XIGENTIMER.VIEWMODEL.isLoggedIn(!0),XIGENTIMER.VIEWMODEL.updateFromFilters(function(){XIGENTIMER.updateDatePickers()}),XIGENTIMER.API.pulse(),XIGENTIMER.drawTaskList(),setTimeout(function(){XIGENTIMER.API.pulse()},3e4)}):$(".login").fadeIn(200)})}),$(".do-reset").on("click",function(){XIGENTIMER.reset()}),$(".time-table-tasks").on("click",".do-selectTask",function(){XIGENTIMER.selectTask(this)}),$(".do-viewonline").on("click",function(){return $(this).attr("disabled")?!1:(o.Window.open("viewActivity.html?activityID="+$(this).attr("data-id"),{frame:!1,title:$(".breadcrumb li").last().text(),width:850,max_width:850,height:450,max_height:450,min_width:800,min_height:400,toolbar:!1}),void 0)}),$("body").on("click","a",function(e){if("_system"===$(this).attr("target")&&(e.preventDefault(),XIGENTIMER.launchExternal($(this).attr("href"))),"_viewProject"===$(this).attr("target")){e.preventDefault();var t=$(this).text();o.Window.open("viewActivity.html?activityID="+$(this).attr("data-id"),{frame:!1,title:t,width:850,max_width:850,height:450,max_height:450,min_width:800,min_height:400,toolbar:!1})}}),XIGENTIMER.BREADCRUMB_CONTAINER=$(".breadcrumbs"),XIGENTIMER.BREADCRUMB_EMPTY=$(".breadcrumbs").contents(),$(".time-table").on("click",".do-editTimeLog",function(){XIGENTIMER.editTimeLog($(this).parents("tr").attr("data-id"),this)}),$("#desc, .filter-text").on("keydown",function(e){(32===e.which||32===e.keyCode)&&e.stopPropagation()}),$(document).on("keyCombo",function(e,t){var i,n=t.combo;"SUBMIT"===n&&XIGENTIMER.sendTime(),("REFRESH"===n||"REFRESH_ALT"===n)&&XIGENTIMER.VIEWMODEL.updateFromFilters(),("SETTINGS"===n||"SETTINGS_ALT"===n)&&$("#settingsMenu").foundation("reveal","open"),"EDIT"===n&&(XIGENTIMER.VIEWMODEL.isTiming()||$("#customTime").foundation("reveal","open")),"FIND"===n&&$(".filter-text").focus(),"PLAYPAUSE"===n&&$(".do-timestart").trigger("click"),"LOGS"===n&&XIGENTIMER.VIEWMODEL.selectTiming(),"TIMER"===n&&XIGENTIMER.VIEWMODEL.selectOverview(),"DESC"===n&&$("#desc").focus(),"LOGOUT"===n&&(i=$(document.activeElement),"filter-text"===i[0].className&&$(".do-clearfilter").trigger("click")),"HELP"===n&&$("#shortcutMenu").foundation("reveal","open"),"VIEW"===n&&("TEXTAREA"!==document.activeElement.tagName?$(".do-viewonline").trigger("click"):$(document.activeElement).val($(document.activeElement).val()+o.Clipboard.get().get("text")))}),$(document).on("open","[data-reveal]",function(){var e=$(this);"customTime"===e[0].id&&setTimeout(function(){e.find("input").first().focus()},200)}),$(".icon-min").on("click",function(){XIGENTIMER.minimize()}),$(".icon-hide").on("click",function(){XIGENTIMER.goToTray()}),$(".icon-close").on("click",function(){XIGENTIMER.close()}),$(".do-refresh").on("click",function(){XIGENTIMER.VIEWMODEL.updateFromFilters(function(){$(".do-refresh").removeClass("is-refreshing").removeAttr("disabled")}),XIGENTIMER.updateDatePickers()})});