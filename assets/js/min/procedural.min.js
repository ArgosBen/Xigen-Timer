$(function(){"use strict";function e(e,s){XIGENTIMER.API.authorizeUser(e,s,function(s){s?(localforage.setItem("user",s),$("[data-avatar]").find("img").remove(),$("[data-avatar]").prepend("<img src='"+o+"&h="+s.AvatarHash+"&id="+s.UserID+"'/>"),XIGENTIMER.updateProjectList(function(){n=new XIGENTIMER.ProjectFilter($(".side-nav"),$(".sidebar-filter-wrap input")),setInterval(function(){XIGENTIMER.updateProjectList(function(e){n.refresh(e)})},6e5)}),XIGENTIMER.renderTimeLogs(),i.isLoggedOut(!1),i.isLoggedIn(!0)):(i.isLoggedOut(!0),i.isLoggedIn(!1),e&&(a.text("Incorrect login, try again! :)").addClass("alert"),setTimeout(function(){a.text(t).removeClass("alert")},1500)))})}var t,i,n,o="http://projectsvm.xigen.co.uk/ImagePage.aspx?t=0",s=require("os"),a=$(".login [type=submit]");$(document).foundation(),XIGENTIMER.loginForm=function(){var o=this;this.isLoggedIn=ko.observable(!1),this.isLoggedOut=ko.observable(!1),this.selectedProject=ko.observable(!1),this.isTiming=ko.observable(!1),this.activityDesc=ko.observable(""),this.isEditingTime=ko.observable(!1),this.taskTypeID=ko.observable(1),this.isOverview=ko.computed(function(){return!o.isEditingTime()&&o.isLoggedIn()}),this.dummy=ko.observable(),this.hasProjectSelected=ko.computed(function(){return!!o.selectedProject()}),this.canEdit=ko.computed(function(){return!o.isTiming()}),this.canSendTime=ko.computed(function(){return o.dummy(),!!o.activityDesc()&&!o.isTiming()&&XIGENTIMER.TIMER.getTime()>0&&!!o.selectedProject()}),this.markText=ko.computed(function(){switch(o.taskTypeID()){case 1:return"Waiting internal review?";case 2:return"Mark as closed?";default:return"Waiting internal review?"}}),this.showMarkComplete=ko.computed(function(){return 3!==o.taskTypeID()}),this.notOSX=!/darwin/.test(s.platform()),this.selectTiming=function(){o.isEditingTime(!0)},this.selectOverview=function(){o.isEditingTime(!1)},this.recalcCanSend=function(){o.dummy.notifySubscribers()},localforage.getItem("authToken",function(t){localforage.getItem("userName",function(i){i&&t?e(t,i):e(!1)})}),$("[data-login]").on("submit",function(i){i.preventDefault();var n,o=$("[name=password]",this).val(),s=$("[name=user]",this).val(),r=$("[name=baseURL]",this).val();t=a.text(),n="Basic "+new Buffer(s+":"+o).toString("base64"),localforage.setItem("authToken",n),localforage.setItem("userName",s),localforage.setItem("baseURL",r+"/rest/v1/"),a.text("Logging in..."),e(n,s)}),$("[data-logout]").on("click",function(e){e.preventDefault(),localforage.setItem("authToken",null),localforage.setItem("userName",null),$("[data-login]")[0].reset(),i.isLoggedOut(!0),i.isLoggedIn(!1),a.text(t),$(".side-nav").empty(),n=!1,XIGENTIMER.reset()})},i=new XIGENTIMER.loginForm,ko.applyBindings(i),XIGENTIMER.VIEWMODEL=i,$(".do-reset").on("click",function(){XIGENTIMER.reset()}),$(".do-viewonline").on("click",function(){XIGENTIMER.launchExternal("http://projects.xigen.co.uk/TaskDetails.aspx?ID="+i.selectedProject())}),$("body").on("click","a",function(e){"_system"===$(this).attr("target")&&(e.preventDefault(),XIGENTIMER.launchExternal($(this).attr("href")))}),$(".time-table").on("click",".button",function(){XIGENTIMER.editTimeLog($(this).parents("tr").attr("data-id"),this)}),$(".icon-min").on("click",function(){XIGENTIMER.minimize()}),$(".icon-hide").on("click",function(){XIGENTIMER.goToTray()}),$(".icon-close").on("click",function(){XIGENTIMER.close()})});