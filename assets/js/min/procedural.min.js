$(function(){"use strict";function e(e,a){XIGENTIMER.API.authorizeUser(e,a,function(a){a?(localforage.setItem("user",a),$("[data-avatar]").find("img").remove(),$("[data-avatar]").prepend("<img src='"+o+"&h="+a.AvatarHash+"&id="+a.UserID+"'/>"),XIGENTIMER.updateProjectList(function(){n||(n=new XIGENTIMER.ProjectFilter($(".side-nav"),$(".sidebar-filter-wrap input")),setInterval(function(){XIGENTIMER.updateProjectList(function(e){console.log("Refreshed..."),n.refresh(e)})},6e5))}),XIGENTIMER.renderTimeLogs(),i.isLoggedOut(!1),i.isLoggedIn(!0)):(i.isLoggedOut(!0),i.isLoggedIn(!1),e&&(s.text("Incorrect login, try again! :)").addClass("warning").removeClass("info"),setTimeout(function(){s.text(t).addClass("info").removeClass("warning")},3e3)))})}var t,i,n,o="http://projectsvm.xigen.co.uk/ImagePage.aspx?t=0",s=$(".login [type=submit]");$(document).foundation(),XIGENTIMER.loginForm=function(){var n=this;this.isLoggedIn=ko.observable(!1),this.isLoggedOut=ko.observable(!1),this.selectedProject=ko.observable(!1),this.isTiming=ko.observable(!1),this.activityDesc=ko.observable(""),this.isEditingTime=ko.observable(!1),this.taskTypeID=ko.observable(1),this.isOverview=ko.computed(function(){return!n.isEditingTime()&&n.isLoggedIn()}),this.dummy=ko.observable(),this.hasProjectSelected=ko.computed(function(){return!!n.selectedProject()}),this.canEdit=ko.computed(function(){return!n.isTiming()}),this.canSendTime=ko.computed(function(){return n.dummy(),!!n.activityDesc()&&!n.isTiming()&&XIGENTIMER.TIMER.getTime()>0&&!!n.selectedProject()}),this.markText=ko.computed(function(){switch(n.taskTypeID()){case 1:return"Waiting internal review?";case 2:return"Mark as closed?";default:return"Waiting internal review?"}}),this.showMarkComplete=ko.computed(function(){return 3!==n.taskTypeID()}),this.selectTiming=function(){n.isEditingTime(!0)},this.selectOverview=function(){n.isEditingTime(!1)},this.recalcCanSend=function(){n.dummy.notifySubscribers()},localforage.getItem("authToken",function(t){localforage.getItem("userName",function(i){i&&t?e(t,i):e(!1)})}),$("[data-login]").on("submit",function(i){i.preventDefault();var n,o=$("[name=password]",this).val(),a=$("[name=user]",this).val();t=s.text(),n="Basic "+new Buffer(a+":"+o).toString("base64"),localforage.setItem("authToken",n),localforage.setItem("userName",a),s.text("Logging in..."),e(n,a)}),$("[data-logout]").on("click",function(e){e.preventDefault(),localforage.setItem("authToken",null),localforage.setItem("userName",null),$("[data-login]")[0].reset(),i.isLoggedOut(!0),i.isLoggedIn(!1),s.text(t)})},i=new XIGENTIMER.loginForm,ko.applyBindings(i),XIGENTIMER.VIEWMODEL=i,$(".do-reset").on("click",function(){XIGENTIMER.reset()}),$(".do-viewonline").on("click",function(){XIGENTIMER.launchExternal("http://projects.xigen.co.uk/TaskDetails.aspx?ID="+i.selectedProject())}),$("body").on("click","a",function(e){"_system"===$(this).attr("target")&&(e.preventDefault(),XIGENTIMER.launchExternal($(this).attr("href")))}),$(".time-table").on("click",".button",function(){XIGENTIMER.editTimeLog($(this).parents("tr").attr("data-id"),this)})});