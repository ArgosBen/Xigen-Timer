!function(){"use strict";function t(t,e){var n,a,i,r,d;localforage.getItem("activityCache",function(e){n=e.filter(function(e){return e.TaskID===t})[0],n&&(a=n.Name,r=n.EntityBaseID,d())}),d=function(){localforage.getItem("projectCache",function(t){n=t.filter(function(t){return t.ProjectID===n.ProjectID})[0],i=n.Name,e([a,i,r])})}}function e(){var t=new Date;return[t.getFullYear(),1===t.getMonth().toString().length?"0"+(t.getMonth()+1):t.getMonth()+1,1===t.getDate().toString().length?"0"+t.getDate():t.getDate()].join("-")}var n={TABLE_CLASS:".time-table-logs",TEXT_EDIT:"Edit",TEXT_SAVE:"Save",TEXT_SAVING:"Saving..."};XIGENTIMER.renderTimeLogs=function(a){XIGENTIMER.API.getTimelogs(function(i){var r,d,o,s,c=$(n.TABLE_CLASS+" tbody"),u=(e(),0),m=document.createDocumentFragment();if(i=i.filter(function(t){return d=+moment(t.EntryDate,"YYYY-MM-DD/HH:mm:ss.SS"),"Locked"!==t.Locked&&!t.Approved&&d>=a[0]&&d<=a[1]}).sort(function(t,e){return o=+moment(t.EntryDate,"YYYY-MM-DD/HH:mm:ss.SS"),s=+moment(e.EntryDate,"YYYY-MM-DD/HH:mm:ss.SS"),s>o?-1:o>s?1:0}).reverse(),i.length>0)$.each(i,function(e){t(this.TaskID,function(t){r=t;var a=document.createElement("tr");a.setAttribute("data-id",i[e].EntityBaseID),a.setAttribute("data-taskId",i[e].TaskID),d=moment(i[e].EntryDate,"YYYY-MM-DD/HH:mm:ss.SS"),$(a).append("<td><strong>"+d.calendar()+"</strong><br/>("+d.format("DD-MM-YYYY")+")</td>"),$(a).append("<td><strong>"+r[1]+":</strong><br/><a target='_system' href='http://projects.xigen.co.uk/TaskDetails.aspx?ID="+r[2]+"'>"+r[0]+"</a></td>"),$(a).append("<td>"+i[e].Duration.toFixed(2)+"</td>"),$(a).append("<td>"+i[e].Description+"</td>"),$(a).append("<td><button data-bind='disable: !isConnected()' class='button tiny success expand do-editTimeLog'>"+n.TEXT_EDIT+"</button></td>"),m.appendChild(a),u+=1,u===i.length&&(c.empty(),c[0].appendChild(m),$.each(c.find("tr"),function(){ko.applyBindings(XIGENTIMER.VIEWMODEL,this)}))})});else{var l=document.createElement("tr");$(l).append("<td align='center' colspan='4'><strong>No time logged for these dates - Do some work!</strong></td>"),m.appendChild(l),c.empty(),c[0].appendChild(m)}})},XIGENTIMER.editTimeLog=function(t,e){var a=$(n.TABLE_CLASS+" tbody").find("[data-id='"+t+"']"),i=(a.attr("data-taskId"),a.find("td").eq(3)),r=a.find("td").eq(2),d=i.text(),o=r.text(),s=/[0-9]{1,2}\.[0-9]{1,2}/,c=!0;e.jquery||(e=$(e)),r.html("<input maxlength='5' type='text' value='"+o+"' />"),i.html("<textarea>"+d+"</textarea>"),e.text(n.TEXT_SAVE),e.on("click",function(){d=i.find("textarea").val(),o=r.find("input").val(),s.test(o)||(r.find("input").addClass("error"),c=!1,r.find("input").on("keyup",function(){s.test($(this).val())?(r.find("input").removeClass("error"),c=!0):r.find("input").addClass("error")})),c&&(e.attr("disabled","disabled"),e.text(n.TEXT_SAVING),XIGENTIMER.API.updateTimeLog(t,o,d,function(){i.html(d),r.html(o),e.removeAttr("disabled"),e.text(n.TEXT_EDIT),e.off("click")}))})},XIGENTIMER.updateDatePickers=function(){var t=$("[data-start]").data("picker"),e=$("[data-end]").data("picker"),n=[];e.setMinDate(t.getDate()),t.setMaxDate(e.getDate()),n.push(+t.getDate()),n.push(+moment(e.getDate()).add("hours",24)),XIGENTIMER.renderTimeLogs(n)}}();